<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Chronus AI</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container dashboard-container">
        <div class="card">
            <div class="profile-header">
                <div class="profile-avatar" id="avatar">
                    <!-- Initials or Image -->
                </div>
                <div class="profile-info">
                    <h2 id="userName">Loading...</h2>
                    <p id="userEmail">...</p>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <div class="info-label">User ID</div>
                    <div class="info-value" id="userId">-</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Status</div>
                    <div class="info-value" style="color: var(--success-color)">Active</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Verified</div>
                    <div class="info-value" id="userVerified">-</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Last Login</div>
                    <div class="info-value" id="lastLogin">-</div>
                </div>
            </div>

            <button onclick="logout()" class="btn btn-primary" style="background-color: #ef4444;">Sign Out</button>
        </div>

        <!-- Chat Interface -->
        <div class="card chat-card" style="margin-top: 20px;">
            <div class="card-header">
                <h2>AI Assistant</h2>
                <p>Ask me to manage your calendar</p>
            </div>
            <div id="chatMessages" class="chat-messages"
                style="height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                <!-- Messages will appear here -->
                <div class="message ai-message">Hello! I can help you manage your calendar. Try saying "Schedule a
                    meeting tomorrow at 2pm".</div>
            </div>
            <div class="chat-input" style="display: flex; gap: 10px;">
                <input type="text" id="messageInput" class="form-control" placeholder="Type your message..."
                    style="margin-bottom: 0;">
                <button onclick="sendMessage()" class="btn btn-primary" style="width: auto;">Send</button>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        checkAuth();

        async function loadProfile() {
            const user = await getProfile();
            if (!user) return;

            document.getElementById('userName').textContent = user.full_name || 'User';
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userId').textContent = user.id;
            document.getElementById('userVerified').textContent = user.is_verified ? 'Yes' : 'No';

            if (user.last_login) {
                document.getElementById('lastLogin').textContent = new Date(user.last_login).toLocaleString();
            }

            const avatar = document.getElementById('avatar');
            if (user.picture) {
                avatar.innerHTML = `<img src="${user.picture}" alt="Profile">`;
            } else {
                const initials = (user.full_name || user.email).substring(0, 2).toUpperCase();
                avatar.textContent = initials;
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            input.value = '';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/v1/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                if (response.ok) {
                    addMessage(data.response, 'ai');
                } else {
                    addMessage(`Error: ${data.detail}`, 'error');
                }
            } catch (error) {
                addMessage(`Error: ${error.message}`, 'error');
            }
        }

        function addMessage(text, type) {
            const messagesDiv = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${type}-message`;
            div.style.marginBottom = '10px';
            div.style.padding = '10px';
            div.style.borderRadius = '8px';

            if (type === 'user') {
                div.style.backgroundColor = '#e3f2fd';
                div.style.marginLeft = '20%';
                div.style.textAlign = 'right';
            } else if (type === 'ai') {
                div.style.backgroundColor = '#f5f5f5';
                div.style.marginRight = '20%';
            } else {
                div.style.backgroundColor = '#ffebee';
                div.style.color = '#c62828';
            }

            div.textContent = text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Allow Enter key to send
        document.getElementById('messageInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });

        loadProfile();
    </script>
</body>

</html>